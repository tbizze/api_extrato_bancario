name: FinSync CI

on:
  push:
    branches:
      - feature/API-48-criando-ci

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # - name: 游뚴 Checkout do reposit칩rio
      #   uses: actions/checkout@v3

      # - name: Setup PHP
      #   uses: shivammathur/setup-php@v2
      #   with:
      #     php-version: "8.1"

      # - name: Instalar Package.json
      #   run: npm install
      # - name: Build Assets
      #   run: npm run build

      - name: Executa comandos remotos via ssh
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.REMOTE_HOST }}
          username: ${{ vars.REMOTE_USER }}
          key: ${{ vars.SERVER_SSH_KEY }}
          port: ${{ vars.REMOTE_PORT }}
          script: |
            cp -f ${{ vars.TARGET }}
            cd domains/ccidadania.com/public_html/finsync

            php -r "file_exists('.env') || copy('.env.example', '.env');"

            # Alterar vari치veis gerais
            sed -i 's/^APP_ENV=local/APP_ENV=production/' .env
            sed -i 's/^APP_NAME=Laravel/APP_NAME=FinSync/' .env
            sed -i 's/^LOG_CHANNEL=stack/LOG_CHANNEL=daily/' .env

            # Alterar vari치vel de BD
            sed -i 's/^DB_DATABASE=Laravel/DB_DATABASE=${{ vars.DB_DATABASE }}/' .env
            sed -i 's/^DB_USERNAME=root/DB_USERNAME=${{ vars.DB_USERNAME }}/' .env
            sed -i 's/^DB_PASSWORD=/DB_PASSWORD=${{ vars.DB_PASSWORD }}/' .env

            # Adicionar novas vari치veis ao final do arquivo
            echo -e '\n# CAMINHO DE ACESSO AO CERTIFICADO E KEY:' >> .env
            echo -e '\n# API_CERT_PATH="app/private/certificates/"' >> .env
            echo -e '\n# API_CERT_PATH="ENVIRONMENT_API="production"' >> .env
            echo -e '\n# SANTANDER_BASE_URI_SANDBOX="https://trust-sandbox.api.santander.com.br"' >> .env
            echo -e '\n# SANTANDER_BASE_URI="https://trust-open.api.santander.com.br"' >> .env
            echo -e '\n# PAGBANK_BASE_URI="https://edi.api.pagseguro.com.br/edi/v1"' >> .env

            # Criar e configurar o arquivo .htaccess
            echo -e '<IfModule mod_rewrite.c>\n
            RewriteEngine On\n
            RewriteBase /\n
            RewriteRule ^-$public/index.php [L]\n
            RewriteRule ^((?!public/).*)$ public/$1 [L]\n
            </IfModule>' 
            > .htaccess
